<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowReader Upload Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .status { margin: 20px 0; padding: 15px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        #bookList { margin-top: 20px; }
        .book-item { padding: 10px; margin: 10px 0; background: #f8f9fa; border-radius: 5px; }
        pre { background: #f4f4f4; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>FlowReader ä¸Šä¼ åŠŸèƒ½æµ‹è¯•</h1>

    <div id="status"></div>

    <h2>æµ‹è¯•æ­¥éª¤ï¼š</h2>
    <ol>
        <li>
            <button onclick="testLocalStorage()">æµ‹è¯• LocalStorage</button>
            - éªŒè¯æµè§ˆå™¨æœ¬åœ°å­˜å‚¨æ˜¯å¦å·¥ä½œ
        </li>
        <li>
            <button onclick="testAPIEndpoint()">æµ‹è¯• API ç«¯ç‚¹</button>
            - éªŒè¯ /api/books/upload æ˜¯å¦å¯è®¿é—®
        </li>
        <li>
            <input type="file" id="fileInput" accept=".epub" onchange="handleFileSelect(event)">
            - é€‰æ‹© EPUB æ–‡ä»¶è¿›è¡Œä¸Šä¼ æµ‹è¯•
        </li>
        <li>
            <button onclick="showStoredBooks()">æ˜¾ç¤ºå­˜å‚¨çš„ä¹¦ç±</button>
            - æŸ¥çœ‹æœ¬åœ°å­˜å‚¨ä¸­çš„ä¹¦ç±
        </li>
        <li>
            <button onclick="clearStorage()">æ¸…é™¤æœ¬åœ°å­˜å‚¨</button>
            - æ¸…é™¤æµ‹è¯•æ•°æ®
        </li>
    </ol>

    <div id="bookList"></div>

    <h2>æµ‹è¯•ç»“æœï¼š</h2>
    <div id="results"></div>

    <script>
        function addStatus(message, type = 'info') {
            const status = document.getElementById('status');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            status.insertBefore(div, status.firstChild);
        }

        function addResult(label, value, success = true) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `status ${success ? 'success' : 'error'}`;
            div.innerHTML = `<strong>${label}:</strong> ${value}`;
            results.appendChild(div);
        }

        // æµ‹è¯• LocalStorage
        function testLocalStorage() {
            try {
                const testKey = 'flowreader_test';
                const testValue = { timestamp: Date.now(), message: 'LocalStorage works!' };
                localStorage.setItem(testKey, JSON.stringify(testValue));
                const retrieved = JSON.parse(localStorage.getItem(testKey));

                if (retrieved && retrieved.timestamp === testValue.timestamp) {
                    addStatus('âœ… LocalStorage æµ‹è¯•é€šè¿‡', 'success');
                    addResult('LocalStorage', 'Working', true);
                } else {
                    throw new Error('Data mismatch');
                }

                localStorage.removeItem(testKey);
            } catch (error) {
                addStatus(`âŒ LocalStorage æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                addResult('LocalStorage', error.message, false);
            }
        }

        // æµ‹è¯• API ç«¯ç‚¹
        async function testAPIEndpoint() {
            try {
                addStatus('æ­£åœ¨æµ‹è¯• API ç«¯ç‚¹...', 'info');

                // è·å– session
                const response = await fetch('/api/books/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                if (response.status === 400) {
                    addStatus('âœ… API ç«¯ç‚¹å“åº”æ­£å¸¸ï¼ˆè¿”å› 400 - ç¼ºå°‘å¿…éœ€å­—æ®µï¼‰', 'success');
                    addResult('API Endpoint', 'Accessible', true);
                } else {
                    addStatus(`âš ï¸ API ç«¯ç‚¹è¿”å›çŠ¶æ€ç : ${response.status}`, 'warning');
                    addResult('API Endpoint', `Status ${response.status}`, false);
                }
            } catch (error) {
                addStatus(`âŒ API ç«¯ç‚¹æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                addResult('API Endpoint', error.message, false);
            }
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            addStatus(`é€‰æ‹©äº†æ–‡ä»¶: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`, 'info');

            try {
                // è¯»å–æ–‡ä»¶
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const arrayBuffer = e.target.result;
                    const uint8Array = new Uint8Array(arrayBuffer);

                    // è½¬æ¢ä¸º base64
                    let binary = '';
                    for (let i = 0; i < uint8Array.length; i++) {
                        binary += String.fromCharCode(uint8Array[i]);
                    }
                    const base64Data = btoa(binary);

                    addStatus('æ–‡ä»¶å·²è½¬æ¢ä¸º Base64', 'info');

                    // æ¨¡æ‹Ÿç”¨æˆ·IDï¼ˆå®é™…åº”è¯¥ä»è®¤è¯ç³»ç»Ÿè·å–ï¼‰
                    const userId = localStorage.getItem('userId') || 'test-user-' + Date.now();
                    localStorage.setItem('userId', userId);

                    // å‘é€åˆ°æœåŠ¡å™¨
                    addStatus('æ­£åœ¨ä¸Šä¼ åˆ°æœåŠ¡å™¨...', 'info');

                    const response = await fetch('/api/books/upload', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            fileName: file.name,
                            fileSize: file.size,
                            fileData: base64Data,
                            userId: userId
                        })
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        addStatus(`âœ… ä¸Šä¼ æˆåŠŸï¼ä¹¦ç±ID: ${result.book?.id}`, 'success');

                        // å¦‚æœæœåŠ¡å™¨æŒ‡ç¤ºä½¿ç”¨æœ¬åœ°å­˜å‚¨
                        if (result.useLocalStorage) {
                            addStatus('ğŸ“Œ ä½¿ç”¨æœ¬åœ°å­˜å‚¨ä¿å­˜ä¹¦ç±', 'warning');
                            const books = JSON.parse(localStorage.getItem('flowreader_local_books') || '[]');
                            books.push(result.book);
                            localStorage.setItem('flowreader_local_books', JSON.stringify(books));
                        }

                        addResult('Upload', `Success - ${result.book?.title || file.name}`, true);

                        // æ˜¾ç¤ºè¿”å›çš„æ•°æ®
                        const details = document.createElement('pre');
                        details.textContent = JSON.stringify(result, null, 2);
                        document.getElementById('results').appendChild(details);

                    } else {
                        addStatus(`âŒ ä¸Šä¼ å¤±è´¥: ${result.error || 'Unknown error'}`, 'error');
                        addResult('Upload', result.error || 'Failed', false);

                        if (result.details) {
                            addStatus(`è¯¦ç»†ä¿¡æ¯: ${result.details}`, 'error');
                        }
                    }
                };

                reader.readAsArrayBuffer(file);

            } catch (error) {
                addStatus(`âŒ æ–‡ä»¶å¤„ç†å¤±è´¥: ${error.message}`, 'error');
                addResult('File Processing', error.message, false);
            }
        }

        // æ˜¾ç¤ºå­˜å‚¨çš„ä¹¦ç±
        function showStoredBooks() {
            try {
                const books = JSON.parse(localStorage.getItem('flowreader_local_books') || '[]');
                const bookList = document.getElementById('bookList');

                if (books.length === 0) {
                    bookList.innerHTML = '<div class="status info">æ²¡æœ‰æ‰¾åˆ°å­˜å‚¨çš„ä¹¦ç±</div>';
                } else {
                    bookList.innerHTML = '<h3>å­˜å‚¨çš„ä¹¦ç±ï¼š</h3>';
                    books.forEach(book => {
                        const div = document.createElement('div');
                        div.className = 'book-item';
                        div.innerHTML = `
                            <strong>${book.title}</strong> - ${book.author || 'Unknown Author'}<br>
                            <small>ID: ${book.id} | ä¸Šä¼ æ—¶é—´: ${book.upload_date || 'Unknown'}</small>
                        `;
                        bookList.appendChild(div);
                    });
                }

                addStatus(`æ‰¾åˆ° ${books.length} æœ¬ä¹¦ç±`, 'info');
            } catch (error) {
                addStatus(`âŒ è¯»å–ä¹¦ç±å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¸…é™¤å­˜å‚¨
        function clearStorage() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æµ‹è¯•æ•°æ®å—ï¼Ÿ')) {
                localStorage.removeItem('flowreader_local_books');
                localStorage.removeItem('flowreader_books'); // ä¹Ÿæ¸…é™¤æ—§çš„key
                localStorage.removeItem('userId');
                addStatus('âœ… æœ¬åœ°å­˜å‚¨å·²æ¸…é™¤', 'success');
                document.getElementById('bookList').innerHTML = '';
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºç¡€æµ‹è¯•
        window.onload = function() {
            addStatus('FlowReader ä¸Šä¼ æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
            testLocalStorage();
        };
    </script>
</body>
</html>
# Story 2.2: Seamless Audio-Text Synchronization

## Status
✅ **Approved** - Ready for Development

## Story

**As a** reader who wants to use "listen + read" mode for maximum comprehension,  
**I want** the audio narration and visual text to be perfectly synchronized,  
**so that** I can follow along with highlighted text that matches exactly what I'm hearing without any manual adjustment.

## Acceptance Criteria

1. **Automatic Synchronization**
   - When audio plays, currently spoken text is highlighted in real-time
   - Text highlighting advances smoothly word-by-word or phrase-by-phrase
   - Synchronization accuracy targets: <0.3s average deviation, <0.5s 95th percentile
   - No manual synchronization or calibration required from user

2. **Visual Highlighting System**
   - Currently spoken text is clearly highlighted with distinct visual styling
   - Highlighting smoothly transitions between words/phrases without jarring jumps
   - Highlighted text remains visible on screen (auto-scroll if needed)
   - User can customize highlight color and style preferences

3. **Playback Controls Integration**
   - Seeking/jumping in audio automatically updates text position
   - Pausing audio freezes text highlighting at current position
   - Speed adjustment maintains accurate synchronization
   - Restarting from any position restores proper sync

4. **Cross-Device Consistency**
   - Audio-text sync works consistently across desktop and mobile devices
   - Performance remains smooth on lower-powered devices
   - Sync accuracy maintained across different network conditions
   - Position synchronization persists when switching between devices

5. **Content Format Compatibility**
   - Synchronization works accurately with EPUB formatted books
   - Compatible with TXT files and various text layouts
   - Handles complex text elements (quotes, dialogue, paragraphs)
   - Maintains sync quality across different book genres and content types

6. **Performance & Reliability**
   - Sync initialization targets: <3s setup, <150ms seek alignment, first highlight <500ms
   - Smooth performance with no noticeable lag or stuttering
   - Robust handling of audio buffering or playback interruptions
   - Graceful fallback when precise timing data is unavailable

## Tasks / Subtasks

- [ ] **Speech Marks Integration** (AC: 1, 3)
  - [ ] Integrate Amazon Polly Speech Marks API for word-level timing
  - [ ] Parse and process speech mark data (word boundaries, timestamps)
  - [ ] Create timing synchronization engine for audio-text mapping
  - [ ] Implement precise timestamp-to-text-position mapping

- [ ] **Real-Time Highlighting System** (AC: 1, 2)
  - [ ] Build dynamic text highlighting component
  - [ ] Implement smooth highlighting transitions
  - [ ] Create auto-scroll functionality for highlighted text
  - [ ] Add customizable highlight styling options
  - [ ] Handle text wrapping and layout changes

- [ ] **Audio Player Integration** (AC: 3)
  - [ ] Sync audio player controls with text position
  - [ ] Implement seek functionality with text jumping
  - [ ] Handle pause/resume state with highlighting freeze
  - [ ] Maintain sync accuracy during speed adjustments
  - [ ] Add scrubbing/seeking with visual text preview

- [ ] **Text Processing Pipeline** (AC: 5)
  - [ ] Create text segmentation for optimal sync granularity
  - [ ] Handle different text formats (EPUB, TXT) consistently
  - [ ] Process complex text structures (dialogue, quotes, formatting)
  - [ ] Build text normalization for speech-to-text matching
  - [ ] Create text indexing for fast position lookups

- [ ] **Synchronization Engine** (AC: 1, 6)
  - [ ] Build high-precision timing controller
  - [ ] Implement audio buffering and latency compensation
  - [ ] Create sync drift detection and correction
  - [ ] Add performance monitoring and optimization
  - [ ] Handle edge cases (pauses, silence, music)

- [ ] **Cross-Platform Optimization** (AC: 4, 6)
  - [ ] Optimize performance for mobile devices
  - [ ] Test and tune sync accuracy across browsers
  - [ ] Implement bandwidth-aware quality adjustments
  - [ ] Add sync state persistence for device switching
  - [ ] Create fallback sync methods when precision data unavailable

## Dev Notes

### Architecture Context
- Audio-text sync is the core differentiating feature of FlowReader
- Relies on Amazon Polly Speech Marks for word-level timing precision
- Integrates with existing TTS system and reading interface
- Must work seamlessly across all supported book formats

### Key Technical Specifications
- **Timing Data**: Amazon Polly Speech Marks provide word-level timestamps
- **Sync Precision**: Target <0.5 second accuracy for word highlighting
- **Granularity**: Word-level or phrase-level highlighting (configurable)
- **Performance**: 60fps smooth highlighting, <100ms response to controls
- **Fallback**: Estimated timing when Speech Marks unavailable

### Critical Implementation Details
- **Speech Marks Format**: JSON with start_time, end_time, word, type fields
- **Text Mapping**: Bidirectional mapping between audio timestamps and text positions with offset compensation
- **Text Normalization**: Standardized text processing pipeline to align TTS input with display text
- **Buffering**: Pre-load timing data and handle audio buffering delays
- **Precision**: Account for audio encoding/decoding latency + browser-specific timing variations
- **Fallback Strategy**: Speed-based estimation when Speech Marks unavailable

### Integration Points
- Connects with TTS audio generation system
- Uses existing text rendering and highlighting infrastructure
- Integrates with audio player controls and state management
- Leverages text processing from EPUB/TXT parsers

### Technical Challenges & Solutions
1. **Timing Precision**: Use high-resolution timestamps and browser audio APIs
2. **Text Segmentation**: Balance granularity with performance and readability  
3. **Cross-Browser Compatibility**: Test audio timing APIs across browsers
4. **Mobile Performance**: Optimize for touch interfaces and lower CPU power

### Browser API Dependencies
- **Web Audio API**: For precise audio timing and control
- **Performance API**: For high-resolution timestamps
- **Intersection Observer**: For auto-scroll and viewport management
- **RequestAnimationFrame**: For smooth highlighting animations

### Testing

**Test Coverage Requirements**:
- Unit tests for timing calculation and text mapping logic
- Integration tests for Speech Marks processing and sync engine
- E2E tests for complete audio-text sync experience
- Performance tests for sync accuracy and smoothness

**Testing Standards**:
- Automated sync accuracy testing with known audio/text pairs
- Cross-browser compatibility testing for timing APIs
- Mobile device performance testing
- Network condition simulation for buffering scenarios

**Specific Test Cases**:
- Word-level highlighting accuracy with various speech speeds
- Seek/jump functionality with immediate text position update
- Pause/resume with exact highlighting position preservation
- Speed adjustment (0.5x to 2x) with maintained sync accuracy
- Long passage sync without cumulative timing drift
- Complex text handling (dialogue, quotes, formatting)
- Audio buffering and network interruption recovery
- Cross-device sync state persistence

### Performance Metrics
- **Sync Accuracy**: <0.5s deviation from expected timing
- **Highlighting Smoothness**: 60fps animation performance
- **Control Response**: <100ms delay for pause/seek/speed changes
- **Memory Usage**: <50MB additional RAM for sync data
- **CPU Usage**: <10% additional CPU load during sync

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-08 | 1.0 | Initial story creation with detailed sync requirements | Sarah (PO) |

## Dev Agent Record

*This section will be populated during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*This section will be populated after QA review*

---

## Addendum · Phased Plan, Formats & Reading Position Sync (2025-09-10)

### Phased Sync Plan

- 先发布“句/段级对齐”（基于云TTS Speech Marks的句界或本地Intl.Segmenter句切），确保体验闭环；随后迭代“词级对齐”。
- 无Marks时回退估算：按句长/标点与速率推算时间轴；文案提示“估算高亮”。

### Timing Data & Storage

- Speech Marks 标注保存为JSON或WebVTT（word/viseme/句界）；播放器消费统一时间轴抽象层。
- 同一章节可存在多版本（不同voice/lang），以`audio_asset_id`关联时间轴。

### Reading Position Sync（MVP）

- POST `/api/position` → `{ book_id, chapter_idx, offset, percent }`；GET `/api/position?book_id` → 最近进度。
- 上报延迟≤500ms；跨设备恢复成功率≥99%。
- 表：`reading_positions(user_id, book_id, chapter_idx, offset, percent, updated_at)`（PK: user_id+book_id）。

### Player Integration

- 播放器与渲染分离，通过“对齐总线”广播当前位置；seek/速度变更驱动时间轴重算。
- 音频资源支持`Range`，断点续播与网络抖动恢复。

### Testing Targets（增补）

- 句级：漂移<200–300ms；词级：p95偏差<500ms。
- seek对齐<150ms；弱网抖动不中断高亮推进；长章无累计漂移。

# Story 2.1: High-Quality Text-to-Speech

## Status
✅ **Approved** - Ready for Development

## Story

**As a** reader who wants to listen to books while commuting or multitasking,  
**I want** to convert any text passage to high-quality, natural-sounding speech,  
**so that** I can enjoy an immersive audio experience that feels like a professional audiobook.

## Acceptance Criteria

1. **TTS Generation Interface**
   - User can activate TTS from any text passage in the reading interface
   - Clear "Listen" button or audio controls are accessible without interrupting reading flow
   - User can select specific text passages for targeted TTS generation
   - Audio controls (play, pause, speed adjustment) are intuitive and responsive

2. **Audio Quality Standards**
   - Generated speech sounds natural and engaging (neural TTS quality)
   - Multiple voice options available (at minimum: 1 male, 1 female voice)
   - Speech speed is adjustable (0.5x to 2x speed range)
   - Audio quality is consistent across different text types (dialogue, narrative, technical content)

3. **Performance & Reliability**
   - TTS generation shows progress with estimated completion time
   - Seamless audio segment concatenation with fade transitions to prevent audio artifacts
   - Audio playback begins immediately when available
   - Robust handling of special characters, punctuation, and formatting
   - Graceful error handling when TTS service is unavailable

4. **Usage Quota Management**
   - System tracks TTS character usage per user in real-time
   - Clear indication of remaining TTS quota for current billing period
   - Graceful quota enforcement with informative messages
   - Option to purchase additional TTS credits when quota is exceeded

5. **Cost Circuit-Breaker Protection** 
   - Hard stop at $100/month per Pro user, $5/month per trial user for API costs
   - Real-time character count and cost estimation before TTS request
   - User confirmation required for requests exceeding cost threshold (>$1)
   - Automatic service suspension when cost limits approached (at 90% threshold)
   - Admin alerts triggered when any user exceeds 80% of their cost limit
   - Emergency override only available through manual admin intervention

6. **Audio Caching & Optimization**
   - Previously generated audio segments are cached for re-use
   - Audio files are compressed for efficient delivery and storage
   - Cache cleanup removes old/unused audio files to manage storage costs
   - Audio delivery is optimized for the user's network conditions

7. **Integration with Reading Experience**
   - TTS respects user's current reading position and progress
   - Generated audio doesn't interfere with other reading features
   - Audio generation works seamlessly across different book formats
   - User can switch between reading and listening modes fluidly

## Tasks / Subtasks

- [ ] **TTS Service Integration** (AC: 1, 2, 3)
  - [ ] Integrate Amazon Polly API with Neural voice models
  - [ ] Implement secure API key management in Vercel Edge Functions
  - [ ] Create text preprocessing for optimal TTS output
  - [ ] Build voice selection and speed adjustment interface
  - [ ] Add audio format optimization (MP3 compression)

- [ ] **Audio Generation Pipeline** (AC: 2, 3)
  - [ ] Create text chunking for long passages (3000 char limit)
  - [ ] Implement batch processing for multiple text segments
  - [ ] Build audio concatenation for seamless long-form content
  - [ ] Add special character and punctuation handling
  - [ ] Implement error handling and retry logic

- [ ] **Quota Management System** (AC: 4, 5)
  - [ ] Create usage tracking in user database
  - [ ] Implement quota checking before TTS generation
  - [ ] Build quota display UI component
  - [ ] Create quota exceeded error handling
  - [ ] Add quota reset automation (monthly)

- [ ] **Cost Circuit-Breaker System** (AC: 5)
  - [ ] Implement real-time cost calculation per API call
  - [ ] Create hard limit enforcement at user tier limits
  - [ ] Build cost warning system (80%, 90% thresholds)
  - [ ] Add automatic service suspension mechanism
  - [ ] Create admin override and alert system
  - [ ] Implement user cost confirmation for expensive operations

- [ ] **Audio Caching Infrastructure** (AC: 5)
  - [ ] Implement audio file caching in Supabase Storage
  - [ ] Create cache key generation based on text content and voice settings
  - [ ] Build cache expiration and cleanup mechanisms
  - [ ] Optimize audio delivery with CDN caching headers
  - [ ] Add cache hit/miss tracking for optimization

- [ ] **Reading Interface Integration** (AC: 1, 6)
  - [ ] Add TTS controls to reading interface
  - [ ] Create text selection → TTS workflow
  - [ ] Implement audio player component with standard controls
  - [ ] Ensure TTS works across EPUB and TXT formats
  - [ ] Add accessibility features for audio controls

- [ ] **Error Handling & User Experience** (AC: 3, 4)
  - [ ] Create comprehensive error message system
  - [ ] Add network failure handling and retries
  - [ ] Build loading states and progress indicators
  - [ ] Implement graceful degradation when TTS unavailable
  - [ ] Add user guidance for optimal TTS usage

## Dev Notes

### Architecture Context
- TTS functionality uses Amazon Polly Neural voices via Vercel Edge Functions
- Audio files are cached in Supabase Storage with automated cleanup
- Usage tracking integrates with existing user quota system
- Text processing happens client-side before API calls for privacy

### Key Technical Specifications
- **TTS Provider**: Amazon Polly with Neural voice models (Joanna, Matthew recommended)
- **Audio Format**: MP3 at 22kHz for optimal size/quality balance
- **Character Limit**: 3000 characters per API call (Polly limitation)
- **Quota Tracking**: Monthly character count stored in user.usage_quotas.tts_characters_used
- **Caching Strategy**: Content-based cache keys with 30-day expiration

### Integration Points
- Uses existing user authentication and quota management
- Integrates with reading interface and text selection
- Connects with audio player controls and progress tracking
- Leverages Supabase Storage for audio file persistence

### Cost Management
- **Pro Tier**: 25 hours (2M characters) monthly quota
- **Trial Tier**: 15 minutes (50K characters) monthly quota
- **Cost Estimation**: ~$16/million characters (Polly Neural pricing) + processing overhead
- **Cache Strategy**: User-scoped caching to avoid privacy/copyright issues
- **Cache Benefits**: 70-80% cache hit rate expected for re-read content
- **Rate Limiting**: Exponential backoff with jitter for API failures

### API Integration Details
- **Polly Parameters**: OutputFormat=mp3, SampleRate=22050, Engine=neural
- **Speech Marks**: Use for future audio-text synchronization feature
- **Security**: API calls proxied through Edge Functions to protect credentials
- **Rate Limiting**: Implement client-side throttling to prevent API abuse

### Testing

**Test Coverage Requirements**:
- Unit tests for text preprocessing and chunking logic
- Integration tests for Polly API interaction
- E2E tests for complete TTS generation workflow
- Performance tests for audio generation speed

**Testing Standards**:
- Mock Polly API responses for unit/integration tests
- Use test audio files for predictable E2E testing
- Performance benchmarks: <10s generation, <2s playback start
- Load testing for quota enforcement under concurrent usage

**Specific Test Cases**:
- Text-to-speech with various content types (dialogue, narrative, technical)
- Voice selection and speed adjustment functionality
- Quota enforcement (before limit, at limit, exceeded)
- Audio caching (cache miss, cache hit, cache expiration)
- Error handling (API failure, network issues, malformed text)
- Long passage chunking and concatenation
- Special character and punctuation handling

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-08 | 1.0 | Initial story creation with comprehensive TTS requirements | Sarah (PO) |

## Dev Agent Record

*This section will be populated during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*This section will be populated after QA review*

---

## Addendum · Runtime, Caching & Local Fallback (2025-09-10)

### Runtime & API

- 将TTS调用放在 Vercel Serverless Functions（Node）以兼容官方SDK与长耗时合成；长任务返回`task_id`后前端轮询。
- POST `/api/tts`（幂等）→ 202 `{ task_id }`；GET `/api/tts/task/:id` → `{ status, audio_url?, marks_url?, error_code? }`。
- 音频产物支持`Range`与CDN缓存；私有书签名URL，公共域长缓存。

### Caching Strategy

- 缓存键：`hash(text) + voice (+ lang)`；不包含`speed`避免版本爆炸。
- 客户端用`audio.playbackRate`在0.8–1.25内调速；>1.25x可增设第二档缓存。
- Speech Marks 时间轴按速率同比例缩放。

### Local TTS Fallback（MVP 默认）

- 当云TTS未开启/超配额/成本守护触发时，默认启用本地TTS：Web Speech API + Intl.Segmenter 句切。
- 边界：不保证词级事件；iOS 需手势触发；文案明确“本地朗读为句级对齐”。
- 埋点：`tts_start|pause|resume|end { source:'local' }`，错误`tts_error { code }`。

### Quota & Cost Guard

- 记录字符用量与成本；到阈值自动降级（禁云TTS→仅本地，或从词级→句级）。
- 错误码：`QUOTA_EXCEEDED`, `RATE_LIMITED`, `INTERNAL_ERROR`；返回同时附剩余额度。

### File Format & Delivery

- 输出 MP3 (22kHz)；Speech Marks 保存JSON或WebVTT；`Cache-Control`区分公共/私有资源。

### Testing Targets（增补）

- 合成排队+合成时间 p95 ≤ 20s（云）；本地TTFT ≤ 300ms。
- 缓存命中（公共域）≥ 60%；Range续播稳定；锁屏/蓝牙媒体控制（支持平台）。

# Story 4.1: AI Conversation Capture & Notes

## Status
✅ **Approved** - Ready for Development

## Story

**As a** reader who has meaningful conversations with the AI about my books,  
**I want** to save complete conversation threads as structured notes,  
**so that** I can preserve my insights, questions, and the AI's analysis as part of my personal reading knowledge base.

## Acceptance Criteria

1. **Conversation Capture Interface**
   - User can save entire AI conversation threads with one click
   - Option to save partial conversations (selected exchanges only)
   - Clear indication when conversation is saved vs. unsaved
   - Saved conversations automatically link to the book and specific text passages

2. **Note Structure & Organization**
   - Saved conversations maintain full context (questions, responses, references)
   - Each note includes timestamp, book reference, and conversation type
   - Conversations are organized by book with easy navigation
   - User can add personal annotations to saved conversations

3. **Integration with Text Passages**
   - Saved conversations preserve links to specific text selections that triggered them
   - User can navigate from conversation back to relevant text passages
   - Multiple conversations can reference the same text passage
   - Text passage context is maintained even if original selection changes

4. **Search & Discovery**
   - User can search across all saved conversations by content
   - Filter conversations by book, date, conversation type, or topic
   - Basic conversation organization (similarity features deferred to v2)
   - Search results show conversation preview with highlighted matching terms

5. **Knowledge Export & Sharing**
   - Conversations can be exported in readable formats (Markdown, PDF)
   - Export includes proper attribution and book context
   - User can create shareable links with privacy controls (disabled by default for copyright protection)
   - Bulk export option for all conversations from a book

6. **Cross-Device Synchronization**
   - Saved conversations sync immediately across all user devices
   - Conversation state (read/unread, annotations) syncs consistently
   - Offline access to previously saved conversations
   - Conflict resolution for simultaneous edits on different devices

## Tasks / Subtasks

- [ ] **Conversation Persistence System** (AC: 1, 2)
  - [ ] Extend AI conversation database schema for note saving
  - [ ] Implement conversation-to-note conversion workflow
  - [ ] Build conversation selection and partial save functionality
  - [ ] Create note metadata management (timestamps, types, tags)
  - [ ] Add user annotation system for saved conversations

- [ ] **Note Organization Interface** (AC: 2, 4)
  - [ ] Create Notes section/page in application
  - [ ] Build conversation list with filtering and sorting
  - [ ] Implement conversation preview and detail views
  - [ ] Add conversation organization by book and topic
  - [ ] Create conversation tagging and categorization system

- [ ] **Text Passage Integration** (AC: 3)
  - [ ] Link conversations to original text selections and positions
  - [ ] Build bidirectional navigation (text ↔ conversation)
  - [ ] Create text highlight system for conversation-referenced passages
  - [ ] Implement passage context preservation across book updates
  - [ ] Handle multiple conversations per text passage

- [ ] **Search & Discovery Engine** (AC: 4)
  - [ ] Implement full-text search across conversation content
  - [ ] Build advanced filtering by book, date, type, and custom tags
  - [ ] Create conversation similarity and recommendation system
  - [ ] Add search result highlighting and relevance ranking
  - [ ] Implement search performance optimization and indexing

- [ ] **Export & Sharing System** (AC: 5)
  - [ ] Build conversation export in multiple formats (Markdown, PDF, JSON)
  - [ ] Create export formatting with proper book context and attribution
  - [ ] Implement shareable conversation links with privacy controls
  - [ ] Add bulk export functionality for book-specific or date-range exports
  - [ ] Create export customization options (include/exclude elements)

- [ ] **Real-time Synchronization** (AC: 6)
  - [ ] Implement real-time conversation sync via Supabase Realtime
  - [ ] Build offline conversation access with caching
  - [ ] Create conflict resolution for simultaneous conversation edits
  - [ ] Add sync status indicators and error handling
  - [ ] Implement conversation state synchronization (read/unread, annotations)

## Dev Notes

### Architecture Context
- Conversation capture transforms FlowReader from a reading app into a knowledge management tool
- Builds on existing AI conversation system and note-taking infrastructure
- Leverages Supabase Realtime for cross-device synchronization
- Integrates with existing book content and text selection systems

### Key Technical Specifications
- **Database Schema**: Extend ai_conversations table with saved_as_note, note_title, user_annotations
- **Search Engine**: Full-text search using PostgreSQL's built-in search or external service
- **Export Formats**: Markdown (primary), PDF (generated), JSON (structured data)
- **Sync Strategy**: Supabase Realtime with optimistic updates and conflict resolution

### Integration Points
- Connects with existing AI conversation system and chat interface
- Uses book content and text selection infrastructure
- Integrates with user authentication and cross-device sync
- Links with potential future knowledge synthesis features

### Data Model Extensions
```sql
-- Add to existing ai_conversations table
ALTER TABLE ai_conversations ADD COLUMN saved_as_note BOOLEAN DEFAULT FALSE;
ALTER TABLE ai_conversations ADD COLUMN note_title TEXT;
ALTER TABLE ai_conversations ADD COLUMN user_annotations JSONB DEFAULT '{}';
ALTER TABLE ai_conversations ADD COLUMN tags TEXT[] DEFAULT '{}';
ALTER TABLE ai_conversations ADD COLUMN is_public BOOLEAN DEFAULT FALSE;
ALTER TABLE ai_conversations ADD COLUMN share_token UUID;
```

### Export Format Specifications
- **Markdown**: Conversation title, book context, Q&A format, user annotations
- **PDF**: Formatted conversation with book cover, proper typography, citations
- **JSON**: Full structured data with metadata for API integrations
- **Shareable Link**: Public access with privacy controls and expiration

### Search Implementation Strategy
1. **PostgreSQL Full-Text Search**: For basic search functionality
2. **Elasticsearch/Algolia**: For advanced search if scale demands it
3. **Client-side Search**: For offline access and instant results
4. **Search Indexing**: Background jobs to maintain search indexes

### Testing

**Test Coverage Requirements**:
- Unit tests for conversation-to-note conversion and metadata management
- Integration tests for search functionality and export generation
- E2E tests for complete save → organize → search → export workflows
- Performance tests for search response times and large conversation datasets

**Testing Standards**:
- Database transaction testing for conversation saving
- Search accuracy testing with known conversation content
- Export format validation and rendering testing
- Cross-device sync testing with multiple browser instances

**Specific Test Cases**:
- Save complete AI conversation as structured note
- Save partial conversation (selected exchanges)
- Search conversations by content with accurate results
- Filter conversations by book, date, and custom criteria
- Export conversation in multiple formats with proper formatting
- Navigate from saved conversation back to original text passage
- Cross-device sync of newly saved conversations
- Offline access to previously saved conversations
- Shareable conversation link creation and access control

### Performance Considerations
- **Search Performance**: Index conversation content for fast full-text search
- **Export Performance**: Generate exports asynchronously for large datasets
- **Sync Performance**: Optimize real-time updates for large conversation collections
- **Storage Efficiency**: Compress conversation data without losing searchability

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-08 | 1.0 | Initial story creation with comprehensive note capture requirements | Sarah (PO) |

## Dev Agent Record

*This section will be populated during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*This section will be populated after QA review*
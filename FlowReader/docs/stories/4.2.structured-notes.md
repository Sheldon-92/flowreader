# Story 4.2: Structured Notes Management

## Status
âœ… **Approved** - Ready for Development

## Story

**As a** reader who captures insights while reading,  
**I want** to create, organize, and review all my reading notes in a structured way,  
**so that** I can efficiently manage my personal knowledge and prepare for discussions or presentations about the books I've read.

## Acceptance Criteria

1. **Note Creation & Types**
   - User can create different types of notes: highlights, annotations, bookmarks, and questions
   - Each note type has appropriate visual styling and functionality
   - Notes can be created from selected text or as standalone thoughts
   - Basic text formatting available for annotations (bold, italic, bullet points only)

2. **Note Organization System**
   - All notes are organized by book with easy navigation between books
   - Timeline view shows all notes in chronological reading order
   - Notes can be tagged with custom labels for cross-book organization
   - Filter and sort notes by type, date, tags, or book

3. **Book-Specific Note Management**
   - User can view all notes for a specific book in one interface
   - Notes show their context within the book (chapter, page, surrounding text)
   - User can navigate from note back to exact location in book
   - Notes maintain their position using content-based anchoring (surrounding text context) even if book content is re-uploaded

4. **Basic Note Editing** 
   - User can edit, expand, or delete any note after creation
   - Add personal thoughts, connections, or reactions to highlighted passages
   - Simple note organization with tags for basic categorization
   - Note editing preserves original book location context

5. **Search & Discovery**
   - Full-text search across all notes and their content
   - Find notes by book, date range, tags, or content keywords
   - Highlight matching terms in search results
   - Quick access to frequently referenced or recent notes

6. **Basic Export & Review**
   - Export notes for a specific book in Markdown format
   - Simple chronological list view for review preparation
   - Basic note summary generation with book context
   - Print-friendly note display for offline review

## Tasks / Subtasks

- [ ] **Note Data Model & Storage** (AC: 1, 4)
  - [ ] Extend existing notes database schema for different note types
  - [ ] Implement basic text storage with simple formatting
  - [ ] Add note tagging and categorization system
  - [ ] Create basic note metadata tracking

- [ ] **Note Creation Interface** (AC: 1)
  - [ ] Build inline note creation from text selection
  - [ ] Create standalone note creation interface
  - [ ] Add basic text formatting controls (bold, italic, bullet points)
  - [ ] Add note type selection with appropriate styling
  - [ ] Create quick note capture shortcuts

- [ ] **Note Organization & Navigation** (AC: 2, 3)
  - [ ] Build Notes dashboard with book-based organization
  - [ ] Create simple chronological list view
  - [ ] Implement basic filtering by book, date, and tags
  - [ ] Build book-specific note management interface
  - [ ] Add note-to-book navigation with position jumping

- [ ] **Note Editing System** (AC: 4)
  - [ ] Create simple note editing interface
  - [ ] Add basic note deletion with confirmation
  - [ ] Implement tag editing and management
  - [ ] Create note content editing with basic formatting

- [ ] **Search & Discovery Engine** (AC: 5)
  - [ ] Implement full-text search across all note content
  - [ ] Build basic filtering interface (book, date, tags, type)
  - [ ] Create search result highlighting
  - [ ] Add basic search functionality

- [ ] **Export & Review Features** (AC: 6)
  - [ ] Build simple note export in Markdown format
  - [ ] Create basic book-specific note compilation
  - [ ] Add simple chronological review list
  - [ ] Create print-friendly note display

## Dev Notes

### Architecture Context
- Structured notes system transforms individual annotations into a comprehensive knowledge base
- Builds on existing note-taking foundation with enhanced organization and management
- Integrates with book content system for precise location tracking
- Supports both casual reading notes and serious academic/professional study

### Key Technical Specifications
- **Database Schema**: Basic notes table with type, tags, and simple formatting
- **Text Format**: Plain text with basic markdown-style formatting
- **Search**: PostgreSQL full-text search with basic indexing
- **Export**: Simple Markdown format export with book context

### Simplified Data Model
```sql
-- Extend existing notes table
ALTER TABLE notes ADD COLUMN tags TEXT[] DEFAULT '{}';
ALTER TABLE notes ADD COLUMN last_modified TIMESTAMPTZ DEFAULT NOW();
ALTER TABLE notes ADD COLUMN is_deleted BOOLEAN DEFAULT FALSE;
```

### Integration Points
- Uses existing book content and text positioning systems
- Integrates with AI conversation capture (notes can include AI discussions)
- Connects with cross-device sync infrastructure

### Note Type Specifications
1. **Highlight**: Selected text with simple visual indication
2. **Annotation**: User commentary on selected or nearby text
3. **Bookmark**: Location markers with optional titles
4. **Question**: User questions about content

### Basic Text Implementation
- **Storage**: Simple text with basic markdown formatting (bold, italic, bullet points only)
- **Rendering**: Consistent styling across application with whitelist-based sanitization
- **Security**: XSS prevention via input sanitization and safe rendering
- **Content Anchoring**: Surrounding text context storage for position persistence

### Search Implementation Strategy
- **Primary Search**: PostgreSQL full-text search with GIN indexes on content and tags
- **Basic Features**: Tag-based filtering, date ranges, note type filtering
- **Performance**: Simple search without complex caching
- **Multi-language**: Configurable text search dictionaries for international users
- **Index Strategy**: Composite indexes on (book_id, created_at), (user_id, tags), tsvector(content)

### Testing

**Test Coverage Requirements**:
- Unit tests for note CRUD operations and basic formatting
- Integration tests for search functionality
- E2E tests for basic note management workflows

**Testing Standards**:
- Basic text formatting testing
- Search accuracy testing with diverse note content
- Cross-device sync testing for note modifications
- Export format validation

**Specific Test Cases**:
- Create different types of notes (highlight, annotation, bookmark, question)
- Basic text formatting across different note types
- Note organization and filtering by book, date, tags, type
- Search notes by content with basic results
- Export notes in Markdown format
- Edit existing notes with basic formatting
- Navigate from note back to exact book location
- Cross-device synchronization of note modifications

### Performance Optimization
- **Database Indexing**: Basic search indexes on note content and tags
- **Pagination**: Simple pagination for note collections

### User Experience Considerations
- **Quick Capture**: Simple note creation during reading
- **Visual Organization**: Clear note type indicators and basic organization
- **Context Preservation**: Always show note's book and location context

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-08 | 1.0 | Initial story creation with comprehensive note management requirements | Sarah (PO) |

## Dev Agent Record

*This section will be populated during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*This section will be populated after QA review*
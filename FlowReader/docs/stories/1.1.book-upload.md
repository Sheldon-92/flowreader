# Story 1.1: Book Upload

## Status
✅ **Approved** - Ready for Development

## Story

**As a** reader who owns personal EPUB and TXT files,  
**I want** to upload my books to FlowReader and have them appear in my personal library,  
**so that** I can access and read my personal collection in FlowReader's enhanced reading environment.

## Acceptance Criteria

1. **File Upload Interface**
   - User can access a clear "Upload Book" interface from the main library page
   - Drag-and-drop functionality is available for EPUB and TXT files
   - File browser selection is available as an alternative to drag-and-drop
   - Upload progress indicator shows during file processing

2. **File Validation & Processing**
   - System accepts EPUB (.epub) and TXT (.txt) files up to 50MB
   - System rejects unsupported formats with clear error messages
   - System attempts to detect DRM/corruption with user-friendly guidance when detection fails
   - System extracts basic metadata (title, author) from EPUB files automatically

3. **Metadata Management**
   - User can manually edit book title and author before confirming upload
   - System generates a unique book ID for each uploaded file
   - System stores file securely in Supabase Storage with proper user isolation

4. **Library Integration**
   - Successfully uploaded book appears immediately in user's library grid
   - Book displays with title, author, and auto-generated or extracted cover image
   - User can click on book to open it in the reading interface
   - Upload progress with time estimation based on file size and connection speed
   - Failed uploads allow retry/resume with progress preservation

5. **Error Handling**
   - Clear error messages for file size exceeded, unsupported format, or network issues
   - Failed uploads allow retry without losing form data
   - System maintains library consistency (no partial uploads in library)

6. **Privacy & Security**
   - Uploaded files are only accessible to the uploading user
   - File content is processed client-side when possible for privacy
   - Server storage follows secure file handling practices

## Tasks / Subtasks

- [ ] **Frontend Upload Interface** (AC: 1)
  - [ ] Create BookUpload component with drag-and-drop zone
  - [ ] Implement file browser fallback option
  - [ ] Add upload progress visualization
  - [ ] Design metadata editing form (title/author)

- [ ] **File Processing Logic** (AC: 2, 3)
  - [ ] Implement client-side file validation (type, size)
  - [ ] Add EPUB metadata extraction using epub.js
  - [ ] Create file upload service with Supabase Storage integration
  - [ ] Implement error handling for corrupted/DRM files

- [ ] **Backend API Integration** (AC: 3, 4)
  - [ ] Create book metadata storage in Supabase database
  - [ ] Implement secure file upload to Supabase Storage
  - [ ] Add book record creation API endpoint
  - [ ] Implement user-specific file access controls

- [ ] **Library Integration** (AC: 4)
  - [ ] Update library grid to display newly uploaded books
  - [ ] Implement real-time book addition via Supabase Realtime
  - [ ] Add navigation from book card to reading interface
  - [ ] Create default cover image generation for books without covers

- [ ] **Error Handling & UX** (AC: 5)
  - [ ] Implement comprehensive error message system
  - [ ] Add retry functionality for failed uploads
  - [ ] Create upload status feedback system
  - [ ] Add form validation and user guidance

## Dev Notes

### Architecture Context
- Upload functionality integrates with Supabase Storage for file persistence
- Client-side EPUB processing uses epub.js library for metadata extraction
- File access follows Row Level Security (RLS) policies for user isolation
- Real-time library updates use Supabase Realtime subscriptions

### Key Technical Specifications
- **File Storage**: Supabase Storage bucket `books` with user-specific folders
- **Database Schema**: Uses `books` table with user_id, title, author, file_path, metadata fields
- **Client Processing**: EPUB metadata extraction happens in browser before upload
- **Security**: RLS policies ensure users only access their own books

### Integration Points
- Connects with library grid display component
- Integrates with reading interface navigation
- Uses shared BookCard component for display consistency
- Leverages authentication system for user context

### Technical Constraints
- 50MB file size limit due to browser memory constraints (with lazy loading optimization)
- EPUB processing requires epub.js library initialization (chunked loading for large files)
- Supabase Storage has built-in virus scanning and security measures
- Duplicate detection via content hash and filename+size comparison
- Cover generation: Extracted from EPUB or generated server-side for TXT files

### Testing

**Test Coverage Requirements**:
- Unit tests for file validation logic
- Integration tests for upload workflow
- E2E tests for complete upload-to-library flow
- Error scenario testing for all failure modes

**Testing Standards**:
- Frontend tests: Vitest + Testing Library in `apps/web/tests/unit/components/`
- Upload service tests: Mock Supabase client for isolated testing
- E2E tests: Playwright tests in `tests/e2e/book-upload.spec.ts`
- Test file fixtures: Store sample EPUB/TXT files in `tests/fixtures/`

**Specific Test Cases**:
- Successful EPUB upload with metadata extraction
- TXT file upload with manual metadata entry
- File size limit enforcement (51MB rejection)
- DRM/corrupted file rejection
- Network failure retry functionality
- Concurrent upload handling

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-08 | 1.0 | Initial story creation with comprehensive AC and tasks | Sarah (PO) |

## Dev Agent Record

*This section will be populated during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*This section will be populated after QA review*

---

## Addendum · Implementation Details (2025-09-10)

### API Contract

- POST `/api/upload`
  - Headers: `Idempotency-Key` (建议=文件hash+owner)
  - FormData: `file` (EPUB)
  - Response 202: `{ task_id: string }`
  - Errors: `TOO_LARGE | INVALID_EPUB | UNSUPPORTED_FORMAT | INTERNAL_ERROR`

- GET `/api/task/:id`
  - 200: `{ status: 'queued'|'processing'|'done'|'failed', book_id?, chapter_count?, error_code? }`
  - 轮询建议：500–1500ms，失败指数退避；`done`后跳转阅读。

- GET `/api/library?cursor&query&sort`
  - 200: `{ items: [{ book_id, title, author, progress, last_read_at, cover_url? }], next_cursor? }`

### Idempotency · Tasks · Data

- 幂等键：`hash(file)+owner_id`，重复上传命中历史结果直接返回。
- 表：
  - `tasks(id, kind, status, payload_hash, idempotency_key, result, error, created_at)`
  - `books(id, owner_id, title, author, meta, namespace, created_at)`
  - `chapters(id, book_id, idx, title, text, index, created_at)`
  - `reading_positions(user_id, book_id, chapter_idx, offset, percent, updated_at)`

### Security · Safety

- 解压白名单、防路径穿越、条目/单章字数阈值；解析在Worker/独立进程。
- 渲染端二次净化（DOMPurify）；阻断/代理外链；严格CSP（禁内联脚本）。

### Analytics Events

- `upload_start { size, name_hash }`
- `upload_success { book_id, duration_ms, chapter_count }`
- `upload_fail { error_code, duration_ms }`
- `parse_duration { book_id, duration_ms }`
- `library_open`, `book_open { book_id }`

### Degradation

- >100MB/章节超阈：拒绝并提示“拆分上传/选择章节导入”。
- 解析超时：后台继续，提示“稍后在图书馆查看”。
- 封面失败：用占位图与dominant color。

### NFR

- 服务端解析 p95 ≤ 10s；内存峰值 < 350MB；有效文件错误率 < 1%。
- `GET /api/task/:id` p95 < 200ms；首屏（首章可滚动）≤ 3s。

### Test Fixtures

- EPUB：5MB/30MB/90MB；损坏EPUB；含SVG/MathML各1；弱网与超时注入用例。

### Error Codes (统一)

- `TOO_LARGE`, `INVALID_EPUB`, `UNSUPPORTED_FORMAT`, `TASK_NOT_FOUND`, `INTERNAL_ERROR`
